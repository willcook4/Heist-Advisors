
<div id="directions-panel" class="hidden"></div>
<div id="map"></div>

<div class="side-panel">
  <div id="floating-panel">
    <div class="location-search">
      <input id="address" type="textbox" value="London, UK">
    </div>
    <div class="location-button">
      <input class="button tiny" id="submit" type="button" value="Geocode">
    </div>
  </div>
  <div class="heist-photo">heist photo</div>
  <div class="risk-reward">
  </div>
  <div class="estimates">
    <div class="police-estimate"></div>
    <div class="criminal-estimate"></div>
    <div class="rob">Rob The Place!</div>
  </div>
  <div class="results">
    <p class="criminalTimeTag">
    </p> 
    <br>
    <p class="policeTimeTag">
    </p>
    <div class="win-or-lose"></div>
  </div>
</div>

<script>
// document.addEventListener("DOMContentLoaded", function() {
console.log("js loaded");
// console.log(document.getElementById('map'));
initMap();
// });
var policeStartLocation;
// var heistLocation;
var endLocation;
var mapCenterLatLng;
var map;
var marker;
var distanceToAirport;
var criminalRandom;
var policeDistanceToHiest;
var policeRandom;

var jewelryStores = [];
var banks = [];
var policeStations = [];
var airports = [];

function initMap() {

  console.log("initializing");
  var directionsService = new google.maps.DirectionsService;
  var directionsDisplay = new google.maps.DirectionsRenderer;
  var policeDirectionsService = new google.maps.DirectionsService();
  var policeDirectionsDisplay;
  // var policeDirectionsDisplay = new google.maps.DirectionsRenderer;
  var airportDirectionsService = new google.maps.DirectionsService();
  var airportDirectionsDisplay;
  // var airportDirectionsDisplay = new google.maps.DirectionsRenderer;


  // Sets the route renderer to draw on the map.
  // directionsDisplay.setMap(map);
  // policeDirectionsDisplay.setMap(map);
  // airportDirectionsDisplay.setMap(map);

  // Create a map
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 13,
    center: {lat: 51.515081, lng: -0.071966},
    mapTypeControl: true,
    mapTypeControlOptions: {
      style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
      position: google.maps.ControlPosition.RIGHT_TOP
    },
    styles: [{"featureType":"all","elementType":"labels.text.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"all","elementType":"labels.text.stroke","stylers":[{"color":"#000000"},{"lightness":13}]},{"featureType":"administrative","elementType":"geometry.fill","stylers":[{"color":"#000000"}]},{"featureType":"administrative","elementType":"geometry.stroke","stylers":[{"color":"#144b53"},{"lightness":14},{"weight":1.4}]},{"featureType":"landscape","elementType":"all","stylers":[{"color":"#08304b"}]},{"featureType":"poi","elementType":"geometry","stylers":[{"color":"#0c4152"},{"lightness":5}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#000000"}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#0b434f"},{"lightness":25}]},{"featureType":"road.arterial","elementType":"geometry.fill","stylers":[{"color":"#000000"}]},{"featureType":"road.arterial","elementType":"geometry.stroke","stylers":[{"color":"#0b3d51"},{"lightness":16}]},{"featureType":"road.local","elementType":"geometry","stylers":[{"color":"#000000"}]},{"featureType":"transit","elementType":"all","stylers":[{"color":"#146474"}]},{"featureType":"water","elementType":"all","stylers":[{"color":"#021019"}]}]
  });
  

  var geocoder = new google.maps.Geocoder();

  document.getElementById('submit').addEventListener('click', function() {
    geocodeAddress(geocoder, map);
    // Once map is loaded...
    google.maps.event.addListenerOnce(map, 'idle', function(){
    // console.log("Map is loaded fully");
    getMapMarkers();
    heistLocation = false;
    endLocation = false;

    });    
  })


// Directions panel
//directionsDisplay.setPanel(document.getElementById('directions-panel'));

//   google.maps.event.addListener(map, 'click', function(event) {
//     if (!heistLocation){
//       heistLocation = event.latLng;
//       console.log('Start selected' + heistLocation);
//     } else if(!!heistLocation && (!endLocation)){
//       endLocation = event.latLng;
//       console.log('End selected' + endLocation);
//       calculateAndDisplayRoute(directionsService, directionsDisplay);
//     } else {
//       console.log(event.latLng);
//     }; 
// });
function calculateAndDisplayRouteForPolice(policeDirectionsService, policeDirectionsDisplay, startPlace) {
  console.log("Police station start point: " + startPlace.geometry.location);
  policeDirectionsService.route({
    origin: startPlace.geometry.location,
    // origin: document.getElementById('start').value,
    destination: heistLocation,
    // destination: document.getElementById('end').value,
    travelMode: 'DRIVING',
    drivingOptions: {
        departureTime: new Date(Date.now()),
        trafficModel: 'optimistic'
      }
  }, function(response, status) {
    if (status === 'OK') {
      // console.log("status okay");
      policeDirectionsDisplay = new google.maps.DirectionsRenderer();
      policeDirectionsDisplay.setOptions({
        preserveViewport: true
      });
      policeDirectionsDisplay.setMap(map);
      policeDirectionsDisplay.setDirections(response);

      // console.log(response);
      console.log("Time for Police to arrive: " + response.routes[0].legs[0].duration.value);

      function totalDistance(route) {
        var total= 0;
        for (i = 0; i < route.legs.length; i++) {
          total += route.legs[i].distance.value;
        }
        console.log("Total Distance for Police to the Heist: " + total);
        policeDistanceToHiest = total;

      }
      totalDistance(response.routes[0]);

    } else {
      window.alert('Directions request failed due to ' + status);
    }
  });
}

function calculateAndDisplayRouteToAirport(airportDirectionsService, airportDirectionsDisplay) {
  var airportLat;
  var airportLng;
  var airportLatLng; 

  $.ajax({
    url: "https://airport.api.aero/airport/nearest/" + heistLocation.lat() + "/" + heistLocation.lng()+"?maxAirports=1&user_key=c6da13c45831bd2e3a96983d43065e7a",
    jsonp: "callback",
    dataType: "jsonp",
    success: function(data){
      // console.log(data.airports[0].lat);
      airportLat = parseFloat(data.airports[0].lat);
      // console.log(data.airports[0].lng);
      airportLng = parseFloat(data.airports[0].lng);
      // console.log(data.airports[0]);
      airportLatLng = new google.maps.LatLng(airportLat, airportLng);
      console.log("Airport: " + airportLatLng);
      airportDirectionsService.route({
        origin: heistLocation,
        destination: airportLatLng,
        travelMode: 'DRIVING'
      }, function(response, status) {
        if (status === 'OK') {
          airportDirectionsDisplay = new google.maps.DirectionsRenderer();
          airportDirectionsDisplay.setOptions({
            preserveViewport: true
          });
          airportDirectionsDisplay.setMap(map);
          airportDirectionsDisplay.setDirections(response);
          console.log(response);
          console.log("Time to get to airport: " + response.routes[0].legs[0].duration.value);
          
          function totalDistance(route) {
            var total= 0;
            for (i = 0; i < route.legs.length; i++) {
              total += route.legs[i].distance.value;
            }
            console.log("Total Distance to airport: " + total+"m");
            distanceToAirport = total;


            var criminalEstimate = Math.ceil(((distanceToAirport/1000)/80)*60)
            $(".criminal-estimate").html("You are about " +criminalEstimate + " minutes away.")
            var policeEstimate = Math.ceil(((distanceToAirport/1000)/90)*60)
            $(".police-estimate").html("The police are about " +policeEstimate + " minutes way")

            $(".rob").on("click", function(){
              policeRandom = ((Math.ceil(Math.random()*100))/100);
              while(policeRandom <= .75){
                policeRandom = ((Math.ceil(Math.random()*100))/100);
              }
              criminalRandom = ((Math.ceil(Math.random()*100))/100);
              while(criminalRandom <= .9){
                criminalRandom = ((Math.ceil(Math.random()*100))/100);
              }
              var criminalTime = (distanceToAirport/1000)/(80*criminalRandom);

              //minutes = policeTime*60 remainder is seconds in decimal
              var criminalRemainder = (criminalTime*60) - (Math.floor(criminalTime*60))
              var criminalSeconds = (Math.floor(criminalRemainder*60))

              console.log("You are " + (Math.floor(criminalTime*60)) + " minutes away and " + criminalSeconds + " seconds away!");

              $(".criminalTimeTag").html("You are " + (Math.floor(criminalTime*60)) + " minutes away and " + criminalSeconds + " seconds away!");



              

              var policeTime = (distanceToAirport/1000)/(90*policeRandom);
              //minutes = policeTime*60 remainder is seconds in decimal
              var policeRemainder = (policeTime*60) - (Math.floor(policeTime*60))
              var policeSeconds = (Math.floor(policeRemainder*60))

              console.log("The police are " + (Math.floor(policeTime*60)) + " minutes away and " + policeSeconds + " seconds away!");

              $(".policeTimeTag").html("The police are " + (Math.floor(policeTime*60)) + " minutes away and " + policeSeconds + " seconds away!");




              if(policeTime < criminalTime){
                //win
                $(".win-or-lose").html("The police find you on your way to the aiport. YOU LOSE");
              } else if(criminalTime < policeTime){
                //lose
                $(".win-or-lose").html("YOU WIN");
              } else if(policeTime = criminalTime){
                //meet the police
                $(".win-or-lose").html("You meet the police at the airport!");
              } else {
                console.error("Something went wrong when determining who wins");
              }
            })

            

          }
          totalDistance(response.routes[0]);
        } else {
          window.alert('Directions request failed due to ' + status);
        }
      });
      }
  });
  // console.log(airportLatLng);
  // console.log("Airport point: ", airport.geometry.location);
  // airportDirectionsService.route({
  //   origin: heistLocation,
  //   destination: airportLatLng,
  //   travelMode: 'DRIVING'
  // }, function(response, status) {
  //   if (status === 'OK') {
  //     airportDirectionsDisplay = new google.maps.DirectionsRenderer();
  //     airportDirectionsDisplay.setMap(map);
  //     airportDirectionsDisplay.setDirections(response);
  //     console.log(response);
  //     console.log("Time to get to airport: " + response.routes[0].legs[0].duration.value);            
  //   } else {
  //     window.alert('Directions request failed due to ' + status);
  //   }
  // });
}  

function clearMarkers(markers) {
  console.log(markers);
  markers.forEach(function(marker) {
    marker.setMap(null);
  });
  return [];
}

// Markers for banks etc
function getMapMarkers() {
  jewelryStores = clearMarkers(jewelryStores);
  banks = clearMarkers(banks);
  policeStations = clearMarkers(policeStations);
  airports = clearMarkers(airports);

  // banks
  var request = {
    location: { lat: map.getCenter().lat(), lng: map.getCenter().lng() },
    radius: '8000',
    type: 'bank'
  };

  // jewelry_store
  var request2 = {
    location: { lat: map.getCenter().lat(), lng: map.getCenter().lng() },
    radius: '8000',
    type: 'jewelry_store'
  };

  // Airports
  // var request3 = {
  //   location: { lat: map.getCenter().lat(), lng: map.getCenter().lng() },
  //   // radius: '15000',
  //   rankBy : google.maps.places.RankBy.DISTANCE,
  //   type: 'airport'
  // };

  // Police
  var request4 = {
    location: { lat: map.getCenter().lat(), lng: map.getCenter().lng() },
    radius: '8000',
    type: 'police'
  };

  service = new google.maps.places.PlacesService(map);
  service.textSearch(request, mapMarkers);
  service.textSearch(request2, mapMarkers);
  // service.textSearch(request3, mapMarkers);
  service.textSearch(request4, mapMarkers);
}

function geocodeAddress(geocoder, resultsMap) {
  var address = document.getElementById('address').value;
  geocoder.geocode({'address': address}, function(results, status) {
    if (status === 'OK') {
      resultsMap.setCenter(results[0].geometry.location);
      // var marker = new google.maps.Marker({
      //   map: resultsMap,
      //   position: results[0].geometry.location
      // }); Creating marker for geocode search result.

    } else {
      alert('Geocode was not successful for the following reason: ' + status);
    }
    // mapCenterLatLng = results[0].geometry.location;
  });
}


function mapMarkers(results, status) {
  
  if (status == google.maps.places.PlacesServiceStatus.OK) {
    for (var i = 0; i < results.length; i++) {
      var place = results[i];
      
      if (place.types.includes("bank")) {
        banks.push(createMarker(results[i], "bank"));

      } else if(place.types.includes("jewelry_store")) {
        jewelryStores.push(createMarker(results[i], "jewelry_store"));
      
      } else if(place.types.includes("airport")) {
        airports.push(createMarker(results[i], "airport"));
      
      } else if(place.types.includes("police")) {
        policeStations.push(createMarker(results[i], 'police'));
      } else {
      }
    } 
  }
}



function findNearestPoliceStation(heistLocation, callback) {
  var request = {
    location: heistLocation,
    rankBy: google.maps.places.RankBy.DISTANCE,
    types: ['police']
  };
  policeService = new google.maps.places.PlacesService(map);
  policeService.nearbySearch(request, function(results, status) {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
      console.log("police search results" + results[0]);
      console.log(results[0]);
      return callback(results[0]);
    } else {
      console.log("Bad search");
    }
  });
}

function findNearestAirport(heistLocation, callback) {
  console.log("HeistLocation" + heistLocation);
  var request = {
    location: heistLocation,
    rankBy: google.maps.places.RankBy.DISTANCE,
    types: ['airport']
  };
  // console.log("request made");
  airportService = new google.maps.places.PlacesService(map);
  airportService.nearbySearch(request, function(results, status) {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
      // console.log("airport places service works");
      return callback(results[0]);
    } else {
      console.log("Bad search for police station...");
    }
  });
}

function heistMarkerListener(marker) {
  marker.addListener('click', function(event) {
    if (!heistLocation) {
      heistLocation = event.latLng;
      console.log('Start selected', event.latLng.lat(), event.latLng.lng());
      findNearestPoliceStation(heistLocation, function(pigShop) {
        console.log("Police Station: " + pigShop.name + ", " + pigShop.formatted_address);
        calculateAndDisplayRouteForPolice(policeDirectionsService, policeDirectionsDisplay, pigShop);
      });
      findNearestAirport(heistLocation, function(airport) {
        // console.log("airport: " + airport);
        calculateAndDisplayRouteToAirport(airportDirectionsService, airportDirectionsDisplay);
      });
    // } else if(!!heistLocation && (!endLocation)){
    //   endLocation = event.latLng;
    //   console.log('End selected' + endLocation);
    //   calculateAndDisplayRoute(directionsService, directionsDisplay, heistLocation);
    }
     
  });
}

// function airportMarkerListener(marker) {
//   google.maps.event.addListener(marker, 'click', function(event) {
//     if (!!heistLocation && (!endLocation)){
//       endLocation = event.latLng;
//       console.log('End selected' + endLocation);
//       calculateAndDisplayRoute(directionsService, directionsDisplay);
//     } else {
//       console.log(event.latLng);
//     }; 
//   });
// }

function createMarker(searchResult, type) {

  // var color = type === "bank" ? "yellow" : 'jewelry_store' ? "red" : 'airport' ? "blue" }
  var color;
  // Marker Color Selection
  // bank = yellow, jewelry_store = red, police = green, airport = blue
  if(type === 'bank') {
    image = "../images/bank.png";
  } else if (type === 'jewelry_store'){
    image = "../images/jewelry.png";
  } else if (type === 'police') {
    image = "../images/police.png";
  } else {
    // airport
    image = "../images/airport.png";
  }

  var marker = new google.maps.Marker({
    position: searchResult.geometry.location,
    map: map,
    animation: google.maps.Animation.DROP,
    icon: image
  });

  if(type === 'bank' || type === 'jewelry_store') {
    heistMarkerListener(marker);  
  } // else if(type === 'airport') {
  //   airportMarkerListener(marker);
  // }
  // markerListener(marker);
  marker.addListener('click', toggleBounce);
  return marker;

  function toggleBounce() {
    if (marker.getAnimation() !== null) {
      marker.setAnimation(null);
    } else {
      marker.setAnimation(google.maps.Animation.BOUNCE);
    }
  }

}
}






</script>
